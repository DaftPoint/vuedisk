<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>File Manager</title>
	<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport" />
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="black" name="apple-mobile-web-app-status-bar-style" />
	<meta content="telephone=no" name="format-detection" />
	<link rel="icon" type="image/png" href="/icons/favico.png" />
	<link rel="stylesheet" href="/css/theme/index.css">
	<link rel="stylesheet" href="/fonts/Roboto/roboto.css">
	<link rel="stylesheet" href="/css/index.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="/js/vue.min.js"></script>
	<script src="/js/vue-router.min.js"></script>
	<script src="/js/httpVueLoader.js"></script>
	<script src="/js/elementui.min.js"></script>
	<script src="/js/element.en.js"></script>
	<script src="/js/axios.min.js"></script>
</head>

<body>
	<div id="vapp">
		<el-container class="container">
			<el-header class="text-center">
				<h1>File Manager</h1>
			</el-header>
			<el-main>
				<el-row type="flex" class="row-bg" justify="space-between">
					<el-col>
						<el-upload :action="'/api/upload.php?dir=' + currentDir" multiple>
							<el-button size="small" type="primary">Add Files</el-button>
						</el-upload>
					</el-col>
					<el-col>
						<el-form :inline="true" style="text-align: right">
							<el-form-item>
								<el-input v-model="dirToAdd"></el-input>
							</el-form-item>
							<el-form-item>
								<el-button type="primary" @click="addDirectory()">New Folder</el-button>
							</el-form-item>
						</el-form>
					</el-col>
				</el-row>
				<el-row style="margin-bottom:25px">
					<el-col :span="24">
						<el-breadcrumb separator-class="el-icon-arrow-right">
							<el-breadcrumb-item><a @click="openDir(baseDir)">Home</a></el-breadcrumb-item>
							<el-breadcrumb-item v-for="(dir, index) in stack"><a @click="openStack(index)">{{dir}}</a></el-breadcrumb-item>
						</el-breadcrumb>
					</el-col>
				</el-row>
				<el-row type="flex" class="row-bg" justify="center">
					<el-col :span="24">
						<el-card>
							<el-table ref="multipleTable" :data="tableDataFinal" style="width: 100%" @selection-change="handleSelectionChange" size="medium">
								<el-table-column type="selection" width="55">
								</el-table-column>
								<el-table-column label="Name">
									<template slot-scope="scope">
										<span v-if="scope.row.isDir" class="fonts" style="font-weight: bold;" @click="openDir(scope.row.path)">{{ scope.row.name }}</span>
										<span v-if="!scope.row.isDir" class="fonts" @click="download(scope.row)">{{ scope.row.name }}</span>
									</template>
								</el-table-column>
								<el-table-column label="Operations" align="right">
									<template slot-scope="scope">
										<span v-if="!scope.row.isDir" style="margin-right: 10px">{{ scope.row.size }}</span>
										<span v-if="scope.row.isDir" style="margin-right: 10px">Directory</span>
										<el-button type="text" size="small">Rename</el-button>
									</template>
								</el-table-column>
							</el-table>
							<el-row type="flex" align="middle" class="row-bg" justify="space-between" style="margin-top: 20px">
								<el-col>
									<el-button>Copy</el-button>
									<el-button>Move</el-button>
									<el-button>Zip</el-button>
									<el-button>Delete</el-button>
								</el-col>
								<el-col style="text-align:right">
									<el-checkbox v-model="hiddenFiles">Show Hidden Files</el-checkbox>
								</el-col>
							</el-row>
						</el-card>
					</el-col>
				</el-row>
			</el-main>
		</el-container>
	</div>
	<script>
	ELEMENT.locale(ELEMENT.lang.en);
	new Vue({
		el: '#vapp',
		data: {
			folderName: '',
			tableData: [],
			multipleSelection: [],
			baseDir: '',
			currentDir: '',
			hiddenFiles: false,
			dirToAdd: ''
		},
		computed: {
			stack() {
				if (this.currentDir && this.baseDir) {
					var substring = this.currentDir.substring(this.baseDir.length);
					if (substring.startsWith('/')) {
						substring = substring.substring(1);
					}
					return substring.split('/');
				}
				return [];
			},
			tableDataFinal() {
				var arrDir = [];
				for (var temp of this.tableData) {
					if (temp.isDir && (this.hiddenFiles || !temp.name.startsWith('.'))) {
						arrDir.push(temp);
					}
				}

				var arrFile = [];
				for (var temp of this.tableData) {
					if (!temp.isDir && (this.hiddenFiles || !temp.name.startsWith('.'))) {
						arrFile.push(temp);
					}
				}

				arrDir.sort((o1, o2) => {
					return o1.name.localeCompare(o2.name);
				});
				arrFile.sort((o1, o2) => {
					return o1.name.localeCompare(o2.name);
				});
				return arrDir.concat(arrFile);
			}
		},
		created() {
			axios.get('/api/base-dir.php')
				.then((response) => {
					this.baseDir = response.data;
					this.openDir(this.baseDir);
				});
		},
		methods: {
			openStack(index) {
				var path = this.baseDir;
				if (path.endsWith('/')) {
					path = path.substring(0, path.length - 1);
				}
				for (var i = 0; i <= index; i++) {
					path = path + "/" + this.stack[i];
				}
				this.openDir(path);
			},
			addDirectory() {
				axios.post('/api/dir-add.php', {
						'dirname' : this.dirToAdd,
						'parentPath' : this.currentDir
					})
					.then((response) => {
						this.openDir(this.currentDir);
					});
			},
			handleSelectionChange(val) {
				this.multipleSelection = val;
			},
			openDir(path) {
				axios.get('/api/files-list.php?path=' + path)
					.then((response) => {
						this.currentDir = path;
						this.tableData = response.data;
					});
			},
			download(file) {
				document.location = `/api/download.php?path=${file.path}`;
			}
		}
	});
	</script>
</body>

</html>
