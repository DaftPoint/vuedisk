<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>File Manager</title>
	<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport" />
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="black" name="apple-mobile-web-app-status-bar-style" />
	<meta content="telephone=no" name="format-detection" />
	<link rel="icon" type="image/png" href="/icons/favico.png" />
	<link rel="stylesheet" href="/css/theme/index.css">
	<link rel="stylesheet" href="/fonts/Roboto/roboto.css">
	<link rel="stylesheet" href="/css/index.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="/js/vue.min.js"></script>
	<script src="/js/vue-router.min.js"></script>
	<script src="/js/httpVueLoader.js"></script>
	<script src="/js/elementui.min.js"></script>
	<script src="/js/element.en.js"></script>
	<script src="/js/axios.min.js"></script>
</head>

<body>
	<div id="vapp">
		<el-container class="container">
			<el-header class="text-center">
				<h1>File Manager</h1>
			</el-header>
			<el-main>
				<el-row type="flex" class="row-bg" justify="space-between">
					<el-col>
						<el-button size="small" type="primary" icon="el-icon-upload">Upload</el-button>
						<el-button type="primary" @click="openRemoteUploadDialog()" size="small" icon="el-icon-upload">Remote Upload</el-button>
						<el-dropdown style="margin-left:10px" split-button type="primary" size="small">
							Dropdown List
							<el-dropdown-menu slot="dropdown">
								<el-dropdown-item>Cut</el-dropdown-item>
								<el-dropdown-item>Copy</el-dropdown-item>
								<el-dropdown-item>Paste</el-dropdown-item>
								<el-dropdown-item>Delete</el-dropdown-item>
								<el-dropdown-item>Get Size</el-dropdown-item>
							</el-dropdown-menu>
						</el-dropdown>
						<i class="el-icon-refresh" style="font-weight: bold;margin-left: 10px;font-size: 20px" @click="refresh()"></i>
						<el-button style="float:right" type="primary" @click="addDirectory()" size="small">New Folder</el-button>
					</el-col>
				</el-row>
				<el-row style="margin: 25px 0">
					<el-col :span="24">
						<el-breadcrumb separator-class="el-icon-arrow-right">
							<el-breadcrumb-item>
								<a @click="openDir('/')">Home</a>
							</el-breadcrumb-item>
							<el-breadcrumb-item v-for="(dir, index) in stack">
								<a @click="openStack(index)">{{dir}}</a>
							</el-breadcrumb-item>
						</el-breadcrumb>
					</el-col>
				</el-row>
				<el-row type="flex" class="row-bg" justify="center">
					<el-col :span="24">
						<el-card>
							<el-table ref="multipleTable" :data="tableDataFinal" style="width: 100%" @selection-change="handleSelectionChange" size="medium">
								<el-table-column type="selection" width="55">
								</el-table-column>
								<el-table-column label="Name">
									<template slot-scope="scope">

											<span v-if="scope.row.isDir" class="fonts" style="font-weight: bold;" @click="openDirFromList(scope.row.name)">{{ scope.row.name }}</span>

											<span v-if="!scope.row.isDir" class="fonts" @click="download(scope.row.name)">{{ scope.row.name }}</span>

										</template>
								</el-table-column>
								<el-table-column align="right">
									<template slot-scope="scope">
											<span v-if="!scope.row.isDir" style="margin-right: 10px">{{ scope.row.size }}</span>
										</template>
								</el-table-column>
							</el-table>
							<el-row type="flex" align="middle" class="row-bg" justify="space-between" style="margin-top: 20px">
								<el-col>
									<el-button>Cut</el-button>
									<el-button>Copy</el-button>
									<el-button>Paste</el-button>
									<el-button>Delete</el-button>
									<el-button>Zip</el-button>
								</el-col>
								<el-col style="text-align:right">
									<el-checkbox v-model="hiddenFiles">Show Hidden Files</el-checkbox>
								</el-col>
							</el-row>
						</el-card>
					</el-col>
				</el-row>
			</el-main>
		</el-container>
		<el-dialog title="Remote File Upload" :visible.sync="remoteUploadDialog">
			<el-form>
				<el-form-item label="File Url" label-width="150">
					<el-input v-model="remoteUrl" auto-complete="off"></el-input>
				</el-form-item>
				<el-form-item label="Name" label-width="150">
					<el-input v-model="remoteUrlName" auto-complete="off"></el-input>
				</el-form-item>
			</el-form>
			<span slot="footer" class="dialog-footer">
					<el-button @click="remoteUploadDialog = false">Cancel</el-button>
					<el-button type="primary" @click="remoteUpload()">Upload</el-button>
				</span>
		</el-dialog>
	</div>
	<script>
		ELEMENT.locale(ELEMENT.lang.en);
		new Vue({
			el: '#vapp',
			data: {
				tableData: [],
				multipleSelection: [],
				currentDir: '/',
				hiddenFiles: false,
				remoteUploadDialog: false,
				remoteUrl: '',
				remoteUrlName: ''
			},
			computed: {
				stack() {
					var substring = this.currentDir;
					if (this.currentDir == '/') {
						return [];
					}
					substring = substring.substring(1);
					return substring.split('/');
				},
				tableDataFinal() {
					var arrDir = [];
					for (var temp of this.tableData) {
						if (temp.isDir && (this.hiddenFiles || !temp.name.startsWith('.'))) {
							arrDir.push(temp);
						}
					}

					var arrFile = [];
					for (var temp of this.tableData) {
						if (!temp.isDir && (this.hiddenFiles || !temp.name.startsWith('.'))) {
							arrFile.push(temp);
						}
					}

					arrDir.sort((o1, o2) => {
						return o1.name.localeCompare(o2.name);
					});
					arrFile.sort((o1, o2) => {
						return o1.name.localeCompare(o2.name);
					});
					return arrDir.concat(arrFile);
				}
			},
			created() {
				this.refresh();
			},
			methods: {
				openRemoteUploadDialog() {
					this.remoteUrl = '';
					this.remoteUrlName = '';
					this.remoteUploadDialog = true;
				},

				remoteUpload() {
					this.remoteUploadDialog = false;
					axios.post('/apis/remote-upload.php', {
						'currentDir': this.currentDir,
						'url': this.remoteUrl,
						'filename': this.remoteUrlName
					}).then((response) => {
						this.$message({
							message: response.data
						});
						this.openDir(this.currentDir);
					});
					this.$message({
						type: 'success',
						message: 'Your file will soon be downloaded'
					});
				},
				openStack(index) {
					var path = '';
					for (var i = 0; i <= index; i++) {
						path = path + '/' + this.stack[i];
					}
					this.openDir(path);
				},
				addDirectory() {
					this.$prompt('Please enter directory name', {
						confirmButtonText: 'Add',
						cancelButtonText: 'Cancel',
					}).then(value => {
						if (value) {
							axios.post('/apis/dir-add.php', {
									'dirname': value.value,
									'parentPath': this.currentDir
								})
								.then((response) => {
									this.$message({
										type: 'success',
										message: 'Directory Added'
									});
									this.refresh();
								}).catch(() => {
									this.$message({
										type: 'error',
										message: 'Unable to add directory'
									});
								})
						}
					}).catch(() => {});
				},

				refresh() {
					this.openDir(this.currentDir);
				},

				handleSelectionChange(val) {
					this.multipleSelection = val;
				},
				openDirFromList(name) {
					if (this.currentDir == '/') {
						this.openDir('/' + name);
					} else {
						this.openDir(this.currentDir + '/' + name);
					}
				},
				openDir(path) {
					axios.get('/apis/files-list.php?path=' + path)
						.then((response) => {
							this.currentDir = path;
							this.tableData = response.data;
						})
						.catch(() => {
							this.$message({
								type: 'error',
								message: 'Unable to fetch contents of Path [ ' + path + ' ]'
							});
						});
				},
				download(name) {
					var path = '';
					if (this.currentDir == '/') {
						path = '/' + name;
					} else {
						path = this.currentDir + '/' + name;
					}
					document.location = '/apis/download.php?path=' + path;
				}
			}
		});
	</script>
</body>

</html>